<!DOCTYPE html>
<html>
    <head>
        <meta charset="UTF-8">
        <title>My Field</title>
        <script src = "node_modules/mathjs/lib/browser/math.js" type = "text/javascript"></script>
        <link rel = 'stylesheet' href = "styles.css">
    </head>

    <body>

        <div id = 'main'>
            <h3 class = 'title'>Vector Field Plotter</h3>
            <div class = 'functionX'></div>
            <div class = 'functionY'></div>
            <canvas id = 'field' height = '600' width = '600'>
                 
            </canvas>
            <div class = 'theDiv'>Hello Nerd</div>
        </div>




        <script type = "text/javascript">

            const functionX = document.querySelector(".functionX");
            const functionY = document.querySelector(".functionY");

            const inputX = document.createElement("input");
            inputX.setAttribute("type", "text");
            inputX.value = "-y";

            const inputY = document.createElement("input");
            inputY.setAttribute("type", "text");
            inputY.value = "x";

            functionX.appendChild(inputX);
            functionY.appendChild(inputY);

            draw();

            inputX.addEventListener('input', function(e){

                try{
                    draw();
                } catch (e){

                }

            });

            inputY.addEventListener('input', function(e){

                try{
                    draw();
                } catch (e){

                }

            });

            

            function VectorXCord( x , y ) {
                let iHat = inputX.value;
                iHat = iHat.replaceAll("x", "(x)");
                iHat = iHat.replaceAll("y", "(y)");
                iHat = iHat.replaceAll("x", x);
                iHat = iHat.replaceAll("y" , y);
                let c = math.evaluate(iHat);
                return c;
            }

            function VectorYCord( x , y ) {
                let jHat = inputY.value;
                jHat = jHat.replaceAll("x", "(x)");
                jHat = jHat.replaceAll("y", "(y)");
                jHat = jHat.replaceAll("x", x);
                jHat = jHat.replaceAll("y" , y);
                let c = math.evaluate(jHat);
                return c;
            }

            function draw() {

                const canvas = document.querySelector("#field");

                if(!canvas.getContext){
                    return;
                }

                let width = canvas.width;
                let height = canvas.height;

                const ctx = canvas.getContext('2d');

                ctx.clearRect(0, 0, width, height);

                //Draw vector lines here

                drawGraphLines(ctx, width, height);

                drawVectors(ctx, width, height);

            }   
            
            function drawGraphLines(ctx, width, height){

                ctx.strokeStyle = 'black';
                ctx.lineWidth = 2;

                ctx.beginPath();
                ctx.moveTo(width / 2, 0);
                ctx.lineTo(width / 2, height);
                ctx.stroke();


                ctx.beginPath();
                ctx.moveTo(0, height / 2);
                ctx.lineTo(width, height / 2);
                ctx.stroke();
                
                
            }

            function drawVectors(ctx, width, height){
                let interval = width / 25;
                let inverseScaleFactor = width / 10;
                for(let i = 0; i < 25; i++){
                    for(let j = 0; j < 25; j++){
                        let X = 10 * (i * interval - width / 2) / width;
                        let Y = 10 * ((height / 2) - j * interval) / height;
                        let dX = VectorXCord(X , Y);
                        let dY = VectorYCord(X , Y);
                        let theta = Math.atan(dY / dX);
                        let magnitude = Math.sqrt(dX * dX + dY * dY);
                        
                        if(dX < 0 && dY >= 0){
                            theta = Math.PI - Math.abs(theta);
                        } else if(dX < 0 && dY < 0){
                            theta = Math.PI + Math.abs(theta);
                        } else if(dX >= 0 && dY <= 0){
                            theta = 2 * Math.PI - Math.abs(theta);
                        }
                        
                        
                        ctx.strokeStyle = `rgb(
                            ${redVal(magnitude)},
                            ${greenVal(magnitude)},
                            ${blueVal(magnitude)}`;
                        
                        
                        
                        let ctxX = inverseScaleFactor * X + width / 2;
                        let ctxY = inverseScaleFactor * Y + height / 2;
                        let sizeX = inverseScaleFactor * Math.cos(theta) / 2;
                        let sizeY = inverseScaleFactor * Math.sin(theta) / 2;
                        let arrowX1 = inverseScaleFactor * Math.cos(theta + Math.PI / 6) / 5;
                        let arrowY1 = inverseScaleFactor * Math.sin(theta + Math.PI / 6) / 5;
                        let arrowX2 = inverseScaleFactor * Math.cos(theta - Math.PI / 6) / 5;
                        let arrowY2 = inverseScaleFactor * Math.sin(theta - Math.PI / 6) / 5;


                        //Draw 1/2 normalized vectors 

                        ctx.beginPath();
                        ctx.moveTo(ctxX, ctxY);
                        ctx.lineTo(ctxX + sizeX, ctxY + sizeY);
                        ctx.stroke();

                        //Draw arrows of vectors

                        ctx.beginPath();
                        ctx.moveTo(ctxX + sizeX, ctxY + sizeY);
                        ctx.lineTo(ctxX + sizeX - arrowX1, ctxY + sizeY - arrowY1);
                        ctx.stroke();

                        ctx.beginPath();
                        ctx.moveTo(ctxX + sizeX, ctxY + sizeY);
                        ctx.lineTo(ctxX + sizeX - arrowX2, ctxY + sizeY - arrowY2);
                        ctx.stroke();
                    }
                } 
            } 
            

            function redVal(magnitude){
                let redVal = 0;
                if(magnitude < 0.6){
                    redVal = 255;
                }
                else if(magnitude < 2.3){
                    redVal = -255 * (Math.log(magnitude + 0.4) - 1);
                } else {
                    redVal = 0;
                }
                return redVal;
            }

            function greenVal(magnitude){
                let greenVal = 0;
                if(magnitude < 0.6){
                    greenVal = 255 + 255 * Math.log(magnitude + 0.4);
                } else if(magnitude < 2.3){
                    greenVal = 255;
                } else if(magnitude < 6.9){
                    greenVal = -255 * (Math.log(magnitude + 0.4) - 2);
                } else {
                    greenVal = 0;
                }
                return greenVal;

            }

            function blueVal(magnitude){
                let blueVal = 0;
                if(magnitude < 0.6){
                    blueVal = 0;
                } else if(magnitude < 2.3){
                    255 + 255 * (Math.log(magnitude + 0.4) - 1); 
                } else {
                    blueVal = 255;
                }
                return blueVal;
                
            }




            dragElement(document.querySelector(".theDiv"));

            function dragElement(elmnt) {

                var pos1 = 0, pos2 = 0, pos3 = 0, pos4 = 0;
                
                const canvas = document.querySelector("#field");

                    
                elmnt.onmousedown = dragMouseDown;
                

                function dragMouseDown(e) {
                    e = e || window.event;
                    e.preventDefault();
                    // get the mouse cursor position at startup:
                    pos3 = e.clientX;
                    pos4 = e.clientY;
                    document.onmouseup = closeDragElement;
                    // call a function whenever the cursor moves:
                    document.onmousemove = elementDrag;
                }

                function elementDrag(e) {
                    e = e || window.event;
                    e.preventDefault();
                    // calculate the new cursor position:
                    pos1 = pos3 - e.clientX;
                    pos2 = pos4 - e.clientY;
                    pos3 = e.clientX;
                    pos4 = e.clientY;

                    let rect = canvas.getBoundingClientRect();
                    

                    if(pos3 >= rect.right){
                        pos1 = 0;
                    } else if(pos3 <= rect.left){
                        pos1 = 0;
                    }
                    if(pos4 >= rect.bottom){
                        pos2 = 0;
                    } else if(pos4 <= rect.top){
                        pos2 = 0;
                    }
                    
                    // set the element's new position:
                    elmnt.style.top = (elmnt.offsetTop - pos2) + "px";
                    elmnt.style.left = (elmnt.offsetLeft - pos1) + "px";
                }

                function closeDragElement() {
                    // stop moving when mouse button is released:
                    document.onmouseup = null;
                    document.onmousemove = null;
                }
            }


        </script>


    </body>
</html>